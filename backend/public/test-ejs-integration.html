<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EJS Template Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>EJS Template Integration Test</h1>
    <p>This page tests the integration between JavaScript modules and EJS templates.</p>

    <!-- Test Results Container -->
    <div id="testResults" class="test-container">
        <h2>Test Results</h2>
        <div id="testSummary"></div>
    </div>

    <!-- EJS Template Structure Test -->
    <div class="test-container">
        <div class="test-section">
            <h3>EJS Template Structure Test</h3>
            <p>This test simulates the DOM structure that would be created by EJS templates.</p>
            <button class="test-button" onclick="testEJSTemplateStructure()">Test EJS Template Structure</button>
            <div id="ejsStructureResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- JavaScript Module Loading Test -->
    <div class="test-container">
        <div class="test-section">
            <h3>JavaScript Module Loading Test</h3>
            <p>This test verifies that all JavaScript modules are loaded correctly.</p>
            <button class="test-button" onclick="testJavaScriptModules()">Test JavaScript Modules</button>
            <div id="jsModulesResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- API Endpoint Compatibility Test -->
    <div class="test-container">
        <div class="test-section">
            <h3>API Endpoint Compatibility Test</h3>
            <p>This test checks if the JavaScript modules can communicate with the backend API.</p>
            <button class="test-button" onclick="testAPICompatibility()">Test API Compatibility</button>
            <div id="apiCompatibilityResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Event Handler Integration Test -->
    <div class="test-container">
        <div class="test-section">
            <h3>Event Handler Integration Test</h3>
            <p>This test verifies that event handlers are properly attached to DOM elements.</p>
            <button class="test-button" onclick="testEventHandlers()">Test Event Handlers</button>
            <div id="eventHandlersResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Permission System Integration Test -->
    <div class="test-container">
        <div class="test-section">
            <h3>Permission System Integration Test</h3>
            <p>This test checks if the permission system works correctly with the UI.</p>
            <button class="test-button" onclick="testPermissionSystem()">Test Permission System</button>
            <div id="permissionSystemResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Form Integration Test -->
    <div class="test-container">
        <div class="test-section">
            <h3>Form Integration Test</h3>
            <p>This test verifies that forms work correctly with the JavaScript modules.</p>
            <form id="testForm" onsubmit="return testFormIntegration(event)">
                <input type="text" name="name" placeholder="Name" required>
                <input type="email" name="email" placeholder="Email" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="test-button">Test Form Integration</button>
            </form>
            <div id="formIntegrationResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <!-- Load all JavaScript modules -->
    <script src="/js/Employee/shared/EmployeeUtils.js"></script>
    <script src="/js/Employee/shared/PermissionsHandler.js"></script>
    <script src="/js/Employee/Admin/AdminLogs.js"></script>
    <script src="/js/Employee/Admin/AdminAlerts.js"></script>
    <script src="/js/Employee/Admin/AdminCMS.js"></script>
    <script src="/js/Employee/Admin/AdminManageUsers.js"></script>
    <script src="/js/Employee/Inventory/InventoryManager.js"></script>
    <script src="/js/Employee/Inventory/InvManagerAlerts.js"></script>
    <script src="/js/Employee/Inventory/InventoryProducts.js"></script>
    <script src="/js/Employee/Support/OrderSupport.js"></script>
    <script src="/js/Employee/Support/SupportManager.js"></script>
    <script src="/js/Employee/Transaction/TransactionManager.js"></script>
    <script src="/js/Employee/UserManager/UserManager.js"></script>

    <script>
        // Test results tracking
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        // Test EJS Template Structure
        function testEJSTemplateStructure() {
            const result = document.getElementById('ejsStructureResult');
            result.style.display = 'block';
            
            testResults.total++;
            
            try {
                // Create mock EJS template structure
                createMockEJSTemplate();
                
                // Test if required elements exist
                const requiredElements = [
                    'activityLogsTable',
                    'usersList',
                    'productsList',
                    'activeChatsList',
                    'recentOrders',
                    'systemAlertsList',
                    'securityAlertsList',
                    'performanceAlertsList',
                    'userActivityAlertsList'
                ];

                let existingElements = 0;
                const missingElements = [];

                requiredElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        existingElements++;
                    } else {
                        missingElements.push(elementId);
                    }
                });

                if (existingElements === requiredElements.length) {
                    result.innerHTML = `
                        <span class="status-indicator status-success"></span>
                        EJS Template Structure Test Passed<br>
                        ✓ All required DOM elements created<br>
                        ✓ Template structure is compatible with JavaScript modules<br>
                        <strong>Result: EJS template structure is working correctly</strong>
                    `;
                    result.className = 'test-result test-success';
                    testResults.passed++;
                } else {
                    result.innerHTML = `
                        <span class="status-indicator status-warning"></span>
                        EJS Template Structure Test Completed with Warnings<br>
                        ✓ ${existingElements}/${requiredElements.length} DOM elements found<br>
                        ${missingElements.length > 0 ? `⚠ Missing elements: ${missingElements.join(', ')}` : ''}<br>
                        <strong>Result: EJS template structure is mostly working</strong>
                    `;
                    result.className = 'test-result test-warning';
                    testResults.warnings++;
                }

            } catch (error) {
                result.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    EJS Template Structure Test Failed<br>
                    ✗ Error: ${error.message}<br>
                    <strong>Result: EJS template structure test failed</strong>
                `;
                result.className = 'test-result test-error';
                testResults.failed++;
            }
        }

        // Create mock EJS template structure
        function createMockEJSTemplate() {
            // Create mock DOM elements that would be generated by EJS templates
            const mockElements = [
                { id: 'activityLogsTable', tag: 'table', content: '<thead><tr><th>Log ID</th><th>User</th><th>Action</th></tr></thead><tbody></tbody>' },
                { id: 'usersList', tag: 'div', content: '' },
                { id: 'productsList', tag: 'div', content: '' },
                { id: 'activeChatsList', tag: 'div', content: '' },
                { id: 'recentOrders', tag: 'div', content: '' },
                { id: 'systemAlertsList', tag: 'div', content: '' },
                { id: 'securityAlertsList', tag: 'div', content: '' },
                { id: 'performanceAlertsList', tag: 'div', content: '' },
                { id: 'userActivityAlertsList', tag: 'div', content: '' }
            ];

            mockElements.forEach(element => {
                if (!document.getElementById(element.id)) {
                    const el = document.createElement(element.tag);
                    el.id = element.id;
                    el.innerHTML = element.content;
                    document.body.appendChild(el);
                }
            });
        }

        // Test JavaScript Modules
        function testJavaScriptModules() {
            const result = document.getElementById('jsModulesResult');
            result.style.display = 'block';
            
            testResults.total++;
            
            try {
                const modules = [
                    'EmployeeUtils',
                    'userPermissions',
                    'AdminLogs',
                    'AdminAlerts',
                    'AdminCMS',
                    'AdminManageUsers',
                    'InventoryManager',
                    'InvManagerAlerts',
                    'InventoryProducts',
                    'OrderSupport',
                    'SupportManager',
                    'TransactionManager',
                    'UserManager'
                ];

                let loadedModules = 0;
                const missingModules = [];

                modules.forEach(module => {
                    if (typeof window[module] !== 'undefined') {
                        loadedModules++;
                    } else {
                        missingModules.push(module);
                    }
                });

                if (loadedModules === modules.length) {
                    result.innerHTML = `
                        <span class="status-indicator status-success"></span>
                        JavaScript Modules Test Passed<br>
                        ✓ All ${modules.length} modules loaded successfully<br>
                        ✓ All modules are available in global scope<br>
                        <strong>Result: All JavaScript modules are working correctly</strong>
                    `;
                    result.className = 'test-result test-success';
                    testResults.passed++;
                } else {
                    result.innerHTML = `
                        <span class="status-indicator status-warning"></span>
                        JavaScript Modules Test Completed with Warnings<br>
                        ✓ ${loadedModules}/${modules.length} modules loaded<br>
                        ${missingModules.length > 0 ? `⚠ Missing modules: ${missingModules.join(', ')}` : ''}<br>
                        <strong>Result: Most JavaScript modules are working</strong>
                    `;
                    result.className = 'test-result test-warning';
                    testResults.warnings++;
                }

            } catch (error) {
                result.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    JavaScript Modules Test Failed<br>
                    ✗ Error: ${error.message}<br>
                    <strong>Result: JavaScript modules test failed</strong>
                `;
                result.className = 'test-result test-error';
                testResults.failed++;
            }
        }

        // Test API Compatibility
        async function testAPICompatibility() {
            const result = document.getElementById('apiCompatibilityResult');
            result.style.display = 'block';
            
            testResults.total++;
            
            try {
                const endpoints = [
                    '/api/rawmaterials',
                    '/api/dashboard/products-count',
                    '/api/dashboard/materials-count',
                    '/api/admin/products',
                    '/api/categories'
                ];

                let workingEndpoints = 0;
                const endpointResults = [];

                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(endpoint);
                        if (response.ok) {
                            workingEndpoints++;
                            endpointResults.push(`✓ ${endpoint} - OK (${response.status})`);
                        } else {
                            endpointResults.push(`⚠ ${endpoint} - ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        endpointResults.push(`✗ ${endpoint} - ${error.message}`);
                    }
                }

                if (workingEndpoints === endpoints.length) {
                    result.innerHTML = `
                        <span class="status-indicator status-success"></span>
                        API Compatibility Test Passed<br>
                        ✓ All ${endpoints.length} API endpoints working<br>
                        ✓ JavaScript modules can communicate with backend<br>
                        <div class="code-block">${endpointResults.join('\n')}</div>
                        <strong>Result: API integration is working correctly</strong>
                    `;
                    result.className = 'test-result test-success';
                    testResults.passed++;
                } else {
                    result.innerHTML = `
                        <span class="status-indicator status-warning"></span>
                        API Compatibility Test Completed with Warnings<br>
                        ✓ ${workingEndpoints}/${endpoints.length} API endpoints working<br>
                        <div class="code-block">${endpointResults.join('\n')}</div>
                        <strong>Result: Most API endpoints are working</strong>
                    `;
                    result.className = 'test-result test-warning';
                    testResults.warnings++;
                }

            } catch (error) {
                result.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    API Compatibility Test Failed<br>
                    ✗ Error: ${error.message}<br>
                    <strong>Result: API integration test failed</strong>
                `;
                result.className = 'test-result test-error';
                testResults.failed++;
            }
        }

        // Test Event Handlers
        function testEventHandlers() {
            const result = document.getElementById('eventHandlersResult');
            result.style.display = 'block';
            
            testResults.total++;
            
            try {
                // Create test elements
                const testContainer = document.createElement('div');
                testContainer.innerHTML = `
                    <button id="testButton">Test Button</button>
                    <form id="testForm">
                        <input type="text" name="testInput" value="test">
                        <button type="submit">Submit</button>
                    </form>
                `;
                document.body.appendChild(testContainer);

                let eventTests = [];

                // Test button click event
                try {
                    const button = document.getElementById('testButton');
                    let clickFired = false;
                    button.addEventListener('click', () => {
                        clickFired = true;
                    });
                    button.click();
                    
                    if (clickFired) {
                        eventTests.push('✓ Button click events working');
                    } else {
                        eventTests.push('✗ Button click events not working');
                    }
                } catch (e) {
                    eventTests.push('✗ Button click events failed: ' + e.message);
                }

                // Test form submission event
                try {
                    const form = document.getElementById('testForm');
                    let submitFired = false;
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        submitFired = true;
                    });
                    form.dispatchEvent(new Event('submit'));
                    
                    if (submitFired) {
                        eventTests.push('✓ Form submission events working');
                    } else {
                        eventTests.push('✗ Form submission events not working');
                    }
                } catch (e) {
                    eventTests.push('✗ Form submission events failed: ' + e.message);
                }

                // Clean up
                document.body.removeChild(testContainer);

                const successCount = eventTests.filter(t => t.startsWith('✓')).length;
                const totalTests = eventTests.length;

                if (successCount === totalTests) {
                    result.innerHTML = `
                        <span class="status-indicator status-success"></span>
                        Event Handlers Test Passed<br>
                        ${eventTests.join('<br>')}<br>
                        <strong>Result: All event handlers are working correctly</strong>
                    `;
                    result.className = 'test-result test-success';
                    testResults.passed++;
                } else {
                    result.innerHTML = `
                        <span class="status-indicator status-warning"></span>
                        Event Handlers Test Completed with Warnings<br>
                        ${eventTests.join('<br>')}<br>
                        <strong>Result: ${successCount}/${totalTests} event handlers working</strong>
                    `;
                    result.className = 'test-result test-warning';
                    testResults.warnings++;
                }

            } catch (error) {
                result.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    Event Handlers Test Failed<br>
                    ✗ Error: ${error.message}<br>
                    <strong>Result: Event handlers test failed</strong>
                `;
                result.className = 'test-result test-error';
                testResults.failed++;
            }
        }

        // Test Permission System
        function testPermissionSystem() {
            const result = document.getElementById('permissionSystemResult');
            result.style.display = 'block';
            
            testResults.total++;
            
            try {
                if (typeof window.userPermissions === 'undefined') {
                    throw new Error('PermissionsHandler not loaded');
                }

                const permissions = window.userPermissions;
                let permissionTests = [];

                // Test permission checking
                try {
                    const hasPermission = permissions.hasPermission('test');
                    permissionTests.push('✓ Permission checking working');
                } catch (e) {
                    permissionTests.push('✗ Permission checking failed: ' + e.message);
                }

                // Test role checking
                try {
                    const isAdmin = permissions.isAdmin();
                    permissionTests.push('✓ Role checking working');
                } catch (e) {
                    permissionTests.push('✗ Role checking failed: ' + e.message);
                }

                // Test UI updates
                try {
                    permissions.updateUI();
                    permissionTests.push('✓ UI update working');
                } catch (e) {
                    permissionTests.push('✗ UI update failed: ' + e.message);
                }

                const successCount = permissionTests.filter(t => t.startsWith('✓')).length;
                const totalTests = permissionTests.length;

                if (successCount === totalTests) {
                    result.innerHTML = `
                        <span class="status-indicator status-success"></span>
                        Permission System Test Passed<br>
                        ${permissionTests.join('<br>')}<br>
                        <strong>Result: Permission system is working correctly</strong>
                    `;
                    result.className = 'test-result test-success';
                    testResults.passed++;
                } else {
                    result.innerHTML = `
                        <span class="status-indicator status-warning"></span>
                        Permission System Test Completed with Warnings<br>
                        ${permissionTests.join('<br>')}<br>
                        <strong>Result: ${successCount}/${totalTests} permission functions working</strong>
                    `;
                    result.className = 'test-result test-warning';
                    testResults.warnings++;
                }

            } catch (error) {
                result.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    Permission System Test Failed<br>
                    ✗ Error: ${error.message}<br>
                    <strong>Result: Permission system test failed</strong>
                `;
                result.className = 'test-result test-error';
                testResults.failed++;
            }
        }

        // Test Form Integration
        function testFormIntegration(event) {
            event.preventDefault();
            
            const result = document.getElementById('formIntegrationResult');
            result.style.display = 'block';
            
            testResults.total++;
            
            try {
                if (typeof window.EmployeeUtils === 'undefined') {
                    throw new Error('EmployeeUtils not available');
                }

                const form = event.target;
                const formData = window.EmployeeUtils.serializeForm(form);
                const validation = window.EmployeeUtils.validateForm(form, {
                    name: { required: true, label: 'Name', minLength: 2 },
                    email: { required: true, label: 'Email', pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/ },
                    password: { required: true, label: 'Password', minLength: 6 }
                });

                if (validation.isValid) {
                    result.innerHTML = `
                        <span class="status-indicator status-success"></span>
                        Form Integration Test Passed<br>
                        ✓ Form data serialized successfully<br>
                        ✓ Form validation working correctly<br>
                        ✓ All validation rules passed<br>
                        <strong>Result: Form integration is working correctly</strong>
                    `;
                    result.className = 'test-result test-success';
                    testResults.passed++;
                } else {
                    result.innerHTML = `
                        <span class="status-indicator status-warning"></span>
                        Form Integration Test Completed with Warnings<br>
                        ✓ Form data serialized successfully<br>
                        ✓ Form validation working correctly<br>
                        ⚠ Validation errors: ${validation.errors.join(', ')}<br>
                        <strong>Result: Form integration is working but found validation errors</strong>
                    `;
                    result.className = 'test-result test-warning';
                    testResults.warnings++;
                }

            } catch (error) {
                result.innerHTML = `
                    <span class="status-indicator status-error"></span>
                    Form Integration Test Failed<br>
                    ✗ Error: ${error.message}<br>
                    <strong>Result: Form integration test failed</strong>
                `;
                result.className = 'test-result test-error';
                testResults.failed++;
            }
        }

        // Update test summary
        function updateTestSummary() {
            const summary = document.getElementById('testSummary');
            const total = testResults.total;
            const passed = testResults.passed;
            const failed = testResults.failed;
            const warnings = testResults.warnings;

            let statusClass = 'test-success';
            let statusIcon = 'status-success';
            let statusText = 'All tests passed';

            if (failed > 0) {
                statusClass = 'test-error';
                statusIcon = 'status-error';
                statusText = 'Some tests failed';
            } else if (warnings > 0) {
                statusClass = 'test-warning';
                statusIcon = 'status-warning';
                statusText = 'All tests passed with warnings';
            }

            summary.innerHTML = `
                <div class="test-result ${statusClass}">
                    <span class="status-indicator ${statusIcon}"></span>
                    <strong>${statusText}</strong><br>
                    Total Tests: ${total} | Passed: ${passed} | Failed: ${failed} | Warnings: ${warnings}
                </div>
            `;
        }

        // Update summary every 2 seconds
        setInterval(updateTestSummary, 2000);

        // Initial summary update
        updateTestSummary();
    </script>
</body>
</html>
